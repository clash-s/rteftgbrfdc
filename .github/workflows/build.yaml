name: build

on:
  push:
    tags:
      - 'v*' # 推送 v1.0.0 等标签触发
  workflow_dispatch: # 支持手动点击按钮触发

jobs:
  build:
    name: Build for ${{ matrix.platform }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            arch: arm64
          - os: windows-latest
            platform: windows
            arch: amd64
          - os: macos-latest
            platform: macos
            arch: arm64
          - os: ubuntu-latest
            platform: linux
            arch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      # 1. 设置 Java (仅 Android)
      - if: matrix.platform == 'android'
        name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 2. 探测预装的 NDK 路径 (解决 setup-ndk 找不到的问题)
      - if: matrix.platform == 'android'
        name: Detect Android NDK
        shell: bash
        run: |
          # 自动寻找系统预装的最新的 NDK 版本
          NDK_PATH=$(ls -d $ANDROID_SDK_ROOT/ndk/* | sort -V | tail -n 1)
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "Detected NDK at: $NDK_PATH"

      # 3. 设置 Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.19'

      # 4. 设置 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          cache: true

      # 5. Linux 系统依赖
      - if: matrix.platform == 'linux'
        name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang cmake ninja-build pkg-config \
            libgtk-3-dev libayatana-appindicator3-dev libkeybinder-3.0-dev \
            liblzma-dev libsecret-1-dev libjsoncpp-dev

      # 6. macOS 系统依赖与权限
      - if: matrix.platform == 'macos'
        name: macOS Setup
        run: |
          sudo gem install cocoapods
          flutter precache --macos
          chmod +x .flutter-git/bin/internal/shared.sh || true

      # 7. 准备与权限修复
      - name: Prepare and Permissions
        shell: bash
        run: |
          chmod -R +x .
          flutter pub get

      # 8. 生成 SDK 代码 (按文档要求的两步走)
      - name: Generate SDK Code
        shell: bash
        run: |
          cd lib/sdk/flutter_xboard_sdk
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          cd ../../..
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs

      # 9. macOS Pod 安装
      - if: matrix.platform == 'macos'
        name: Install Pods
        run: |
          cd macos && pod install && cd ..

      # 10. 执行构建
      - name: Build Application
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          CGO_ENABLED: 1
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            export PATH=$PATH:$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin
            dart setup.dart android
          elif [ "${{ matrix.platform }}" == "windows" ]; then
            # Windows 构建通常需要 MinGW，GitHub 镜像已自带
            dart setup.dart windows --arch ${{ matrix.arch }}
          elif [ "${{ matrix.platform }}" == "macos" ]; then
            dart setup.dart macos --arch ${{ matrix.arch }}
          elif [ "${{ matrix.platform }}" == "linux" ]; then
            dart setup.dart linux --arch ${{ matrix.arch }}
          fi

      # 11. 整理产物用于发布
      - name: Prepare Artifacts for Release
        shell: bash
        run: |
          mkdir -p release_files
          # Android APK
          find build/app/outputs/flutter-apk/ -name "*.apk" -exec cp {} release_files/ \; || true
          # Windows EXE
          find build/windows/runner/Release/ -name "*.exe" -exec cp {} release_files/ \; || true
          # macOS ZIP
          if [ "${{ matrix.platform }}" == "macos" ]; then
            cd build/macos/Build/Products/Release/
            zip -r ../../../../release_files/xboard-macos-${{ matrix.arch }}.zip *.app
            cd ../../../..
          fi
          # Linux Tarball
          if [ "${{ matrix.platform }}" == "linux" ]; then
            tar -czvf release_files/xboard-linux-${{ matrix.arch }}.tar.gz -C build/linux/${{ matrix.arch }}/release/bundle/ .
          fi

      # 12. 上传到 Release 页面 (展现为下载链接)
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          files: release_files/*
          tag_name: ${{ github.ref_name || 'latest' }}
          name: Release ${{ github.ref_name || 'Manual Build' }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
