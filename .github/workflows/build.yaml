name: build

on:
  push:
    tags:
      - 'v*' 
  workflow_dispatch: 

jobs:
  build:
    name: Build for ${{ matrix.platform }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write # 必须开启写入权限才能创建 Release 链接
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            arch: arm64
          - os: windows-latest
            platform: windows
            arch: amd64
          - os: macos-latest
            platform: macos
            arch: arm64
          - os: ubuntu-latest
            platform: linux
            arch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      # 1. 基础环境设置
      - if: matrix.platform == 'android'
        name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - if: matrix.platform == 'android'
        name: Detect NDK
        run: |
          NDK_PATH=$(ls -d $ANDROID_SDK_ROOT/ndk/* | sort -V | tail -n 1)
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
        shell: bash

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.21' # 推荐使用较新版本以适配 Clash 核心

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          cache: true

      # 2. Linux 专项加固：补全打包工具 (解决 AppBuilder.build 报错)
      - if: matrix.platform == 'linux'
        name: Install Linux Build & Pack Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang cmake ninja-build pkg-config \
            libgtk-3-dev libayatana-appindicator3-dev libkeybinder-3.0-dev \
            liblzma-dev libsecret-1-dev libjsoncpp-dev libnm-dev \
            coreutils binutils dpkg-dev # 增加打包所需的二进制工具链

      - if: matrix.platform == 'macos'
        name: macOS Setup
        run: |
          sudo gem install cocoapods
          flutter precache --macos

      # 3. 预处理与权限 (防止 Build.exec 权限错误)
      - name: Prepare
        run: |
          chmod -R +x .
          flutter pub get
        shell: bash

      # 4. 生成 SDK 代码
      - name: Generate SDK Code
        run: |
          cd lib/sdk/flutter_xboard_sdk
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          cd ../../..
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
        shell: bash

      - if: matrix.platform == 'macos'
        name: Install Pods
        run: cd macos && pod install && cd ..

      # 5. 构建应用
      - name: Build Application
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          CGO_ENABLED: 1
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            export PATH=$PATH:$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin
            dart setup.dart android
          elif [ "${{ matrix.platform }}" == "windows" ]; then
            dart setup.dart windows --arch ${{ matrix.arch }}
          elif [ "${{ matrix.platform }}" == "macos" ]; then
            dart setup.dart macos --arch ${{ matrix.arch }}
          elif [ "${{ matrix.platform }}" == "linux" ]; then
            dart setup.dart linux --arch ${{ matrix.arch }}
          fi
        shell: bash

      # 6. 整理产物并生成下载链接
      - name: Prepare Artifacts for Release
        run: |
          mkdir -p release_files
          # Android
          find build/app/outputs/flutter-apk/ -name "*.apk" -exec cp {} release_files/ \; || true
          # Windows
          find build/windows/runner/Release/ -name "*.exe" -exec cp {} release_files/ \; || true
          # macOS
          if [ "${{ matrix.platform }}" == "macos" ]; then
            cd build/macos/Build/Products/Release/
            zip -r ../../../../release_files/xboard-macos-${{ matrix.arch }}.zip *.app
            cd ../../../..
          fi
          # Linux
          if [ "${{ matrix.platform }}" == "linux" ]; then
            tar -czvf release_files/xboard-linux-${{ matrix.arch }}.tar.gz -C build/linux/${{ matrix.arch }}/release/bundle/ .
          fi
        shell: bash

      - name: Create Release Link
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          files: release_files/*
          tag_name: ${{ github.ref_name || 'manual-build' }}
          name: Release ${{ github.ref_name || 'Manual Build' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
