name: build

on:
  push:
    tags:
      - 'v*' # 当你推送以 v 开头的标签（如 v1.0.0）时触发发布
  workflow_dispatch: # 支持手动触发并发布

jobs:
  build:
    name: Build for ${{ matrix.platform }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            arch: arm64
          - os: windows-latest
            platform: windows
            arch: amd64
          - os: macos-latest
            platform: macos
            arch: arm64
          - os: ubuntu-latest
            platform: linux
            arch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - if: matrix.platform == 'android'
        name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - if: matrix.platform == 'android'
        name: Setup NDK
        uses: nndung179/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.19'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          cache: true

      - if: matrix.platform == 'macos'
        name: macOS Specific Setup
        run: |
          sudo gem install cocoapods
          flutter precache --macos
        shell: bash

      - if: runner.os == 'Linux'
        name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang cmake ninja-build pkg-config \
            libgtk-3-dev libayatana-appindicator3-dev libkeybinder-3.0-dev \
            liblzma-dev libsecret-1-dev libjsoncpp-dev

      - name: Prepare and Permissions
        run: |
          chmod -R +x .
          flutter pub get
        shell: bash

      - name: Generate SDK Code
        run: |
          cd lib/sdk/flutter_xboard_sdk
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          cd ../../..
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
        shell: bash

      - if: matrix.platform == 'macos'
        name: Install Pods
        run: |
          cd macos && pod install && cd ..
        shell: bash

      - name: Build Application
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CGO_ENABLED: 1
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            export PATH=$PATH:$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin
            dart setup.dart android
          elif [ "${{ matrix.platform }}" == "windows" ]; then
            dart setup.dart windows --arch ${{ matrix.arch }}
          elif [ "${{ matrix.platform }}" == "macos" ]; then
            dart setup.dart macos --arch ${{ matrix.arch }}
          elif [ "${{ matrix.platform }}" == "linux" ]; then
            dart setup.dart linux --arch ${{ matrix.arch }}
          fi
        shell: bash

      # 关键步骤：整理产物文件（为了方便展示下载链接）
      - name: Prepare Artifacts for Release
        run: |
          mkdir -p release_files
          # 移动 Android APK
          find build/app/outputs/flutter-apk/ -name "*.apk" -exec cp {} release_files/ \; || true
          # 移动 Windows EXE
          find build/windows/runner/Release/ -name "*.exe" -exec cp {} release_files/ \; || true
          # 压缩 macOS App (macOS 必须压缩后下载)
          if [ "${{ matrix.platform }}" == "macos" ]; then
            cd build/macos/Build/Products/Release/
            zip -r ../../../../release_files/xboard-macos-${{ matrix.arch }}.app.zip *.app
            cd ../../../..
          fi
          # 压缩 Linux Bundle
          if [ "${{ matrix.platform }}" == "linux" ]; then
            tar -czvf release_files/xboard-linux-${{ matrix.arch }}.tar.gz -C build/linux/${{ matrix.arch }}/release/bundle/ .
          fi
        shell: bash

      # 关键步骤：上传到 GitHub Release 展现为下载链接
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          files: release_files/*
          tag_name: ${{ github.ref_name || 'latest' }}
          name: Release ${{ github.ref_name || 'Manual Build' }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
